import{initializeApp as nt}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";import{getAuth as st,signInAnonymously as at}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{getFirestore as it,addDoc as P,collection as L,serverTimestamp as ot,updateDoc as x,query as N,orderBy as Q,getDocs as S,doc as $,onSnapshot as ct}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";(function(){const w=document.createElement("link").relList;if(w&&w.supports&&w.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))k(c);new MutationObserver(c=>{for(const l of c)if(l.type==="childList")for(const b of l.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&k(b)}).observe(document,{childList:!0,subtree:!0});function y(c){const l={};return c.integrity&&(l.integrity=c.integrity),c.referrerPolicy&&(l.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?l.credentials="include":c.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function k(c){if(c.ep)return;c.ep=!0;const l=y(c);fetch(c.href,l)}})();const rt={apiKey:"AIzaSyClDZMbUilVMkFEVsbYFcazM8eDyqnPO_A",authDomain:"room-quiz.firebaseapp.com",projectId:"room-quiz",storageBucket:"room-quiz.appspot.com",messagingSenderId:"239392402318",appId:"1:239392402318:web:e30034538cee23b7db92df"};async function dt(){const I=nt(rt),w=st(I),y=it(I);await at(w);const k=document.getElementById("hostBtn"),c=document.getElementById("joinBtn"),l=document.getElementById("hostPanel"),b=document.getElementById("joinPanel"),q=document.getElementById("roomsList"),p=document.getElementById("roomPane"),j=document.getElementById("roomTitle"),D=document.getElementById("maxPlayers"),O=document.getElementById("hostQuestions"),H=document.getElementById("createRoom");k.onclick=()=>{l.classList.remove("hidden"),b.classList.add("hidden")},c.onclick=()=>{l.classList.add("hidden"),b.classList.remove("hidden"),T()};const g=()=>w.currentUser?.uid,_=["A","B","C","D"];function a(n,t={},s=[]){const e=document.createElement(n);for(const[i,o]of Object.entries(t))i==="class"?e.className=o:i==="text"?e.textContent=o:e.setAttribute(i,o);return(s||[]).forEach(i=>e.appendChild(i)),e}function M(n){const t=n.split(/\n\s*\n/).map(e=>e.trim()).filter(Boolean),s=[];for(const e of t){const i=e.split(/\n/).map(r=>r.trim()).filter(Boolean);if(i.length<6)continue;const o=i[0].replace(/^\d+\.?\s*/,""),h=[];for(const r of _){const B=i.find(E=>new RegExp(`^${r}[)\\.]\\s*`,"i").test(E))||"";h.push(B.replace(/^[A-Da-d][)\\.]\\s*/,"").trim())}const v=((i.find(r=>/^answer\s*:/i.test(r))||"").match(/[A-D]/i)||[null])[0],A=(i.find(r=>/^explanation\s*:/i.test(r))||"").replace(/^explanation\s*:\s*/i,"");v&&s.push({q:o,options:h,answer:{A:0,B:1,C:2,D:3}[v.toUpperCase()],explanation:A})}return s}async function F(n){return(await S(N(L($(y,"rooms",n),"questions"),Q("index")))).docs.map(s=>({id:s.id,...s.data()})).sort((s,e)=>s.index-e.index)}H.onclick=async()=>{const n=j.value.trim()||"Quiz Room",t=Math.max(1,parseInt(D.value||"0",10)),s=M(O.value);if(!t){alert("Enter participant count");return}if(s.length===0){alert("Paste questions first");return}const e=await P(L(y,"rooms"),{title:n,maxParticipants:t,participants:{},status:"lobby",currentIndex:0,answers:{},nextAcks:{},createdAt:ot()});await Promise.all(s.map((i,o)=>P(L(e,"questions"),{index:o,...i}))),await x(e,{[`participants.${g()}`]:!0}),R(e.id,!0),j.value="",D.value="",O.value=""};async function T(){q.innerHTML='<div class="muted">Loading…</div>';const n=N(L(y,"rooms"),Q("createdAt")),t=await S(n);q.innerHTML="";const s=t.docs.map(e=>({id:e.id,...e.data()})).filter(e=>["lobby","in_progress","countdown","question","reveal","wait_more"].includes(e.status));if(!s.length){q.innerHTML='<div class="muted">No public rooms yet.</div>';return}s.forEach(e=>{const i=e.participants?Object.keys(e.participants).length:0,o=a("div",{class:"item"});o.appendChild(a("div",{},[a("div",{text:e.title||"Room"}),a("div",{class:"muted",text:`${e.status} · ${i}/${e.maxParticipants} joined`})]));const h=a("button",{class:"btn",text:"Join"});h.onclick=()=>U(e.id),o.appendChild(h),q.appendChild(o)})}async function U(n){const t=$(y,"rooms",n);await x(t,{[`participants.${g()}`]:!0}),R(n,!1)}let C=null;async function R(n,t){C&&C(),p.innerHTML='<div class="center">Loading room…</div>';const s=$(y,"rooms",n),e=await F(n);C=ct(s,async i=>{if(!i.exists()){p.innerHTML='<div class="center">Room not found</div>';return}const o={...i.data()};X(s,o,e,t)})}async function W(n,t,s){t.status==="question"&&await x(n,{[`answers.${g()}`]:{choice:s,at:Date.now()}})}async function K(n){await x(n,{[`nextAcks.${g()}`]:!0})}async function V(n,t,s){if(!s||t.status!=="lobby")return;Object.keys(t.participants||{}).length>=(t.maxParticipants||1)&&await x(n,{status:"countdown",countdownEndsAt:Date.now()+3e3})}async function G(n,t,s){!s||t.status!=="countdown"||Date.now()>=(t.countdownEndsAt||0)&&await x(n,{status:"question",answers:{},nextAcks:{}})}async function J(n,t){if(t.status!=="question")return;const s=Object.keys(t.participants||{}).length,e=Object.keys(t.answers||{}).length;s>0&&e>=s&&await x(n,{status:"reveal"})}async function Y(n,t,s){if(t.status!=="reveal")return;const e=Object.keys(t.participants||{}).length;if(Object.keys(t.nextAcks||{}).length>=e){const o=t.currentIndex+1;o>=s?await x(n,{status:"wait_more",answers:{},nextAcks:{}}):await x(n,{status:"question",currentIndex:o,answers:{},nextAcks:{}})}}async function Z(n,t){const s=M(t);if(!s.length){alert("Nothing parsed");return}const e=L(n,"questions"),i=Date.now();await Promise.all(s.map((o,h)=>P(e,{index:i+h,...o}))),await x(n,{status:"question",answers:{},nextAcks:{}})}function X(n,t,s,e){p.innerHTML="";const i=t.participants?Object.keys(t.participants).length:0,o=a("div",{class:"row"});o.appendChild(a("div",{class:"muted",text:`${t.title||"Room"} · ${i}/${t.maxParticipants} players`}));const h=a("button",{class:"btn bad",text:"Leave"});if(h.onclick=()=>{C&&C(),p.innerHTML='<div class="center">Left room.</div>'},o.appendChild(h),p.appendChild(o),V(n,t,e),G(n,t,e),t.status==="lobby"){p.appendChild(a("div",{class:"center",text:`Waiting for players ${i}/${t.maxParticipants}…`}));return}if(t.status==="countdown"){const d=t.countdownEndsAt||Date.now(),f=a("div",{class:"center"}),m=a("div",{class:"count",text:"3"});f.appendChild(m),p.appendChild(f);const et=setInterval(()=>{const z=Math.ceil((d-Date.now())/1e3);m.textContent=z>0?z:"Go!",Date.now()>=d&&clearInterval(et)},200);return}const u=s.find(d=>d.index===t.currentIndex);if(!u){p.appendChild(a("div",{class:"center",text:"Waiting for first question…"}));return}const v=t.status==="reveal",A=t.answers?.[g()]?.choice??null,r=a("div",{class:"qbox"});r.appendChild(a("div",{class:"muted",text:`Question ${s.findIndex(d=>d.index===u.index)+1}`})),r.appendChild(a("div",{style:"font-size:20px;margin:6px 0 10px 0;font-weight:700",text:u.q}));const B=["A","B","C","D"],E=a("div",{class:"answers"});u.options.forEach((d,f)=>{const m=a("button",{class:"ans",text:`${B[f]}. ${d}`});m.disabled=v||A!==null,m.onclick=()=>W(n,t,f),v&&(f===u.answer&&m.classList.add("correct"),f===A&&A!==u.answer&&m.classList.add("wrong")),E.appendChild(m)}),r.appendChild(E);const tt=Object.keys(t.answers||{}).length;if(r.appendChild(a("div",{class:"muted",text:`Answered: ${tt}/${i}`})),v){r.appendChild(a("div",{style:"height:8px"})),r.appendChild(a("div",{class:"muted",text:`Correct: ${B[u.answer]}. ${u.options[u.answer]}`})),u.explanation&&r.appendChild(a("div",{style:"margin-top:6px",text:`Explanation: ${u.explanation}`}));const d=a("button",{class:"btn primary",text:"Next"});d.style.marginTop="10px",d.onclick=()=>K(n),r.appendChild(d),Y(n,t,s.length)}else J(n,t);if(t.status==="wait_more")if(e){const d=a("div",{class:"stack"});d.style.marginTop="10px";const f=a("textarea");f.placeholder="Provide more questions (same format)…";const m=a("button",{class:"btn ok",text:"Add & Continue"});m.onclick=()=>Z(n,f.value),d.appendChild(f),d.appendChild(m),p.appendChild(d)}else p.appendChild(a("div",{class:"center",text:"Waiting for more questions from the host…"}));p.appendChild(r)}T()}dt();
