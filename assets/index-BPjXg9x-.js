import{initializeApp as at}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";import{getAuth as it,signInAnonymously as ot}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";import{getFirestore as ct,addDoc as P,collection as L,serverTimestamp as rt,updateDoc as x,query as S,orderBy as H,getDocs as _,doc as $,onSnapshot as dt}from"https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";(function(){const w=document.createElement("link").relList;if(w&&w.supports&&w.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))k(c);new MutationObserver(c=>{for(const l of c)if(l.type==="childList")for(const b of l.addedNodes)b.tagName==="LINK"&&b.rel==="modulepreload"&&k(b)}).observe(document,{childList:!0,subtree:!0});function y(c){const l={};return c.integrity&&(l.integrity=c.integrity),c.referrerPolicy&&(l.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?l.credentials="include":c.crossOrigin==="anonymous"?l.credentials="omit":l.credentials="same-origin",l}function k(c){if(c.ep)return;c.ep=!0;const l=y(c);fetch(c.href,l)}})();const lt={apiKey:"AIzaSyClDZMbUilVMkFEVsbYFcazM8eDyqnPO_A",authDomain:"room-quiz.firebaseapp.com",projectId:"room-quiz",storageBucket:"room-quiz.appspot.com",messagingSenderId:"239392402318",appId:"1:239392402318:web:e30034538cee23b7db92df"};async function ut(){const I=at(lt),w=it(I),y=ct(I);await ot(w);const k=document.getElementById("hostBtn"),c=document.getElementById("joinBtn"),l=document.getElementById("hostPanel"),b=document.getElementById("joinPanel"),q=document.getElementById("roomsList"),p=document.getElementById("roomPane"),j=document.getElementById("roomTitle"),D=document.getElementById("maxPlayers"),O=document.getElementById("hostQuestions"),F=document.getElementById("createRoom");k.onclick=()=>{l.classList.remove("hidden"),b.classList.add("hidden")},c.onclick=()=>{l.classList.add("hidden"),b.classList.remove("hidden"),T()};const g=()=>{var e;return(e=w.currentUser)==null?void 0:e.uid},U=["A","B","C","D"];function a(e,t={},s=[]){const n=document.createElement(e);for(const[i,o]of Object.entries(t))i==="class"?n.className=o:i==="text"?n.textContent=o:n.setAttribute(i,o);return(s||[]).forEach(i=>n.appendChild(i)),n}function M(e){const t=e.split(/\n\s*\n/).map(n=>n.trim()).filter(Boolean),s=[];for(const n of t){const i=n.split(/\n/).map(r=>r.trim()).filter(Boolean);if(i.length<6)continue;const o=i[0].replace(/^\d+\.?\s*/,""),h=[];for(const r of U){const B=i.find(E=>new RegExp(`^${r}[)\\.]\\s*`,"i").test(E))||"";h.push(B.replace(/^[A-Da-d][)\\.]\\s*/,"").trim())}const v=((i.find(r=>/^answer\s*:/i.test(r))||"").match(/[A-D]/i)||[null])[0],A=(i.find(r=>/^explanation\s*:/i.test(r))||"").replace(/^explanation\s*:\s*/i,"");v&&s.push({q:o,options:h,answer:{A:0,B:1,C:2,D:3}[v.toUpperCase()],explanation:A})}return s}async function W(e){return(await _(S(L($(y,"rooms",e),"questions"),H("index")))).docs.map(s=>({id:s.id,...s.data()})).sort((s,n)=>s.index-n.index)}F.onclick=async()=>{const e=j.value.trim()||"Quiz Room",t=Math.max(1,parseInt(D.value||"0",10)),s=M(O.value);if(!t){alert("Enter participant count");return}if(s.length===0){alert("Paste questions first");return}const n=await P(L(y,"rooms"),{title:e,maxParticipants:t,participants:{},status:"lobby",currentIndex:0,answers:{},nextAcks:{},createdAt:rt()});await Promise.all(s.map((i,o)=>P(L(n,"questions"),{index:o,...i}))),await x(n,{[`participants.${g()}`]:!0}),R(n.id,!0),j.value="",D.value="",O.value=""};async function T(){q.innerHTML='<div class="muted">Loading…</div>';const e=S(L(y,"rooms"),H("createdAt")),t=await _(e);q.innerHTML="";const s=t.docs.map(n=>({id:n.id,...n.data()})).filter(n=>["lobby","in_progress","countdown","question","reveal","wait_more"].includes(n.status));if(!s.length){q.innerHTML='<div class="muted">No public rooms yet.</div>';return}s.forEach(n=>{const i=n.participants?Object.keys(n.participants).length:0,o=a("div",{class:"item"});o.appendChild(a("div",{},[a("div",{text:n.title||"Room"}),a("div",{class:"muted",text:`${n.status} · ${i}/${n.maxParticipants} joined`})]));const h=a("button",{class:"btn",text:"Join"});h.onclick=()=>K(n.id),o.appendChild(h),q.appendChild(o)})}async function K(e){const t=$(y,"rooms",e);await x(t,{[`participants.${g()}`]:!0}),R(e,!1)}let C=null;async function R(e,t){C&&C(),p.innerHTML='<div class="center">Loading room…</div>';const s=$(y,"rooms",e),n=await W(e);C=dt(s,async i=>{if(!i.exists()){p.innerHTML='<div class="center">Room not found</div>';return}const o={...i.data()};et(s,o,n,t)})}async function V(e,t,s){t.status==="question"&&await x(e,{[`answers.${g()}`]:{choice:s,at:Date.now()}})}async function G(e){await x(e,{[`nextAcks.${g()}`]:!0})}async function J(e,t,s){if(!s||t.status!=="lobby")return;Object.keys(t.participants||{}).length>=(t.maxParticipants||1)&&await x(e,{status:"countdown",countdownEndsAt:Date.now()+3e3})}async function Y(e,t,s){!s||t.status!=="countdown"||Date.now()>=(t.countdownEndsAt||0)&&await x(e,{status:"question",answers:{},nextAcks:{}})}async function Z(e,t){if(t.status!=="question")return;const s=Object.keys(t.participants||{}).length,n=Object.keys(t.answers||{}).length;s>0&&n>=s&&await x(e,{status:"reveal"})}async function X(e,t,s){if(t.status!=="reveal")return;const n=Object.keys(t.participants||{}).length;if(Object.keys(t.nextAcks||{}).length>=n){const o=t.currentIndex+1;o>=s?await x(e,{status:"wait_more",answers:{},nextAcks:{}}):await x(e,{status:"question",currentIndex:o,answers:{},nextAcks:{}})}}async function tt(e,t){const s=M(t);if(!s.length){alert("Nothing parsed");return}const n=L(e,"questions"),i=Date.now();await Promise.all(s.map((o,h)=>P(n,{index:i+h,...o}))),await x(e,{status:"question",answers:{},nextAcks:{}})}function et(e,t,s,n){var z,N;p.innerHTML="";const i=t.participants?Object.keys(t.participants).length:0,o=a("div",{class:"row"});o.appendChild(a("div",{class:"muted",text:`${t.title||"Room"} · ${i}/${t.maxParticipants} players`}));const h=a("button",{class:"btn bad",text:"Leave"});if(h.onclick=()=>{C&&C(),p.innerHTML='<div class="center">Left room.</div>'},o.appendChild(h),p.appendChild(o),J(e,t,n),Y(e,t,n),t.status==="lobby"){p.appendChild(a("div",{class:"center",text:`Waiting for players ${i}/${t.maxParticipants}…`}));return}if(t.status==="countdown"){const d=t.countdownEndsAt||Date.now(),f=a("div",{class:"center"}),m=a("div",{class:"count",text:"3"});f.appendChild(m),p.appendChild(f);const st=setInterval(()=>{const Q=Math.ceil((d-Date.now())/1e3);m.textContent=Q>0?Q:"Go!",Date.now()>=d&&clearInterval(st)},200);return}const u=s.find(d=>d.index===t.currentIndex);if(!u){p.appendChild(a("div",{class:"center",text:"Waiting for first question…"}));return}const v=t.status==="reveal",A=((N=(z=t.answers)==null?void 0:z[g()])==null?void 0:N.choice)??null,r=a("div",{class:"qbox"});r.appendChild(a("div",{class:"muted",text:`Question ${s.findIndex(d=>d.index===u.index)+1}`})),r.appendChild(a("div",{style:"font-size:20px;margin:6px 0 10px 0;font-weight:700",text:u.q}));const B=["A","B","C","D"],E=a("div",{class:"answers"});u.options.forEach((d,f)=>{const m=a("button",{class:"ans",text:`${B[f]}. ${d}`});m.disabled=v||A!==null,m.onclick=()=>V(e,t,f),v&&(f===u.answer&&m.classList.add("correct"),f===A&&A!==u.answer&&m.classList.add("wrong")),E.appendChild(m)}),r.appendChild(E);const nt=Object.keys(t.answers||{}).length;if(r.appendChild(a("div",{class:"muted",text:`Answered: ${nt}/${i}`})),v){r.appendChild(a("div",{style:"height:8px"})),r.appendChild(a("div",{class:"muted",text:`Correct: ${B[u.answer]}. ${u.options[u.answer]}`})),u.explanation&&r.appendChild(a("div",{style:"margin-top:6px",text:`Explanation: ${u.explanation}`}));const d=a("button",{class:"btn primary",text:"Next"});d.style.marginTop="10px",d.onclick=()=>G(e),r.appendChild(d),X(e,t,s.length)}else Z(e,t);if(t.status==="wait_more")if(n){const d=a("div",{class:"stack"});d.style.marginTop="10px";const f=a("textarea");f.placeholder="Provide more questions (same format)…";const m=a("button",{class:"btn ok",text:"Add & Continue"});m.onclick=()=>tt(e,f.value),d.appendChild(f),d.appendChild(m),p.appendChild(d)}else p.appendChild(a("div",{class:"center",text:"Waiting for more questions from the host…"}));p.appendChild(r)}T()}ut();
